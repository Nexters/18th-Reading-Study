# 4장 쿼리

## 4.1 find 소개

쿼리는 컬렉션에서 도큐먼트의 subset을 반환한다. 빈 쿼리 도먼트는 컬렉션 내 모든 것과 일치한다.
쿼리 도큐먼트에 여러 개의 키/값 쌍을 추가할 수 있으며 **조건 1 AND 조건 2 AND ... AND 조건N** 으로 해석된다.

### 반환받을 키 지정

때때로 반환받은 도큐먼트 내 키/값 정보가 모두 필요하지는 않을 수 있다. 그럴 때는 `find`의 두 번째 매개변수에 원하는 키를 지정한다.
이는 네트워크 상 데이터 전송량과 클라이언트 측에서 디코딩하는 데 드는 시간과 메모리를 줄여준다.

**단, "\_id"키는 지정하지 않아도 항상 반환되며 설정해주면 제외할 수도 있다.**

## 4.2 쿼리 조건

### 쿼리 조건절

`<` `<=` `>` `>=` : `$lt` `$lte` `$gt` `$gte`

- 범위 쿼리는 날짜 쿼리에 유용하다. 날짜는 밀리초 단위로 저장되므로 정확히 일치하는 것보다 범위 쿼리를 더 많이 사용한다.
- `$ne`는 모든 데이터 형에서 사용할 수 있다.

### OR 쿼리

- `$in`은 하나의 키를 다양한 값과 비교하는 쿼리에 사용한다. 매우 유연하므로 여러 개의 값을 쓸 수 있고 서로 다른 데이터형도 쓸 수 있다.
  - `$nin`은 반대로 조건과 일치하지 않는 도큐먼트를 반환한다.
- `$or`은 더 일반적이며 여러 키를 주어진 값과 비교하는 쿼리에 사용한다.
  - **첫 번째 인수가 일치하는 도큐먼트가 많을수록 효율적이다.**

🏋️‍♀️ **쿼리 옵티마이저**는 `$in`은 더 효율적으로 다룬다! 가능한 `$in`을 사용하자.

### `$not`

메타 조건절로 어떤 조건에도 적용할 수 있고 정규 표현식과 함께 사용해 주어진 패턴과 일치하지 않는 도큐먼트를 찾을 때 유용하다.

## 4.3 형 특정 쿼리

### null

`null`은 스스로와 일치하는 것을 찾는다.
`null`은 '존재하지 않음'과도 일치하므로 해당 키를 갖지 않는 도큐먼트도 반환한다.

값이 `null`인 키만 찾고 싶으면 키가 `null`인 값을 쿼리하고, **`$exists` 조건절을** 사용해 `null` 존재 여부를 확인한다.

### 정규 표현식

`$regex`는 쿼리에서 패턴 일치 문자열을 위한 정규식 기능을 제공한다.
몽고DB는 정규 표현식 일치에 펄 호환 정규 표현식(PCRE) 라이브러리를 사용한다.

### 배열에 쿼리하기

배열 요소 쿼리는 스칼라 쿼리와 같은 방식으로 동작하도록 설계됐다.

#### `$all` 연산자

2개 이상의 배열 요소가 일치하는 배열을 찾으려면 `$all`을 사용한다.
순서는 중요하지 않다.

#### `$size` 연산자

특정 크기의 배열을 쿼리하는 조건절이다.

#### `$slice` 연산자

`find`의 두 번째 매개변수에는 반환받을 특정 키를 지정하는데, `$slice` 연산자를 사용해서 배열 요소의 부분집합을 반환받을 수 있다.
또한, 오프셋과 요소 개수를 지정해 원하는 범위 안에 있는 결과를 반환할 수 있다.

#### 배열 및 범위 쿼리

일반적으로 배열을 포함하는 도큐먼트에 범위 쿼리를 할 때 min 함수와 max 함수를 사용하면 좋다.
배열에 대한 `$gt` `lt` 쿼리의 인덱스 한계는 비효율적이다.
어떤 값이든 허용하므로 범위 내 값뿐 아니라 모든 인덱스 항목을 검색한다.

### 내장 도큐먼트에 쿼리하기

내장 도큐먼트 쿼리는 도큐먼트 전체를 대상으로 하는 방식과 도큐먼트 내 키/값 쌍 각각을 대상으로 하는 방식으로 나뉜다.

내장 도큐먼트를 쿼리할 때는 가능하다면 특정 키로 쿼리하는 방법이 좋다. 스키마가 변경되더라도 모든 쿼리가 정상적으로 작동하기 때문이다.
**내장 도큐먼트의 키를 쿼리할 때는 dot notation을 사용한다.**

내장 도큐먼트에서 2개 이상의 키의 조건 일치 여부를 확인할 때는 `$elemMatch`를 사용한다.

## 4.4 $where 쿼리

`$where` 절을 사용해 임의의 자바스크립트를 쿼리의 일부분으로 실행하면 (거의) 모든 쿼리를 표현할 수 있다.
따라서 보안상의 이유로 해당 절을 제한해야 한다.

`$where` 절은 도큐먼트 내 두 키의 값을 비교하는 쿼리에 가장 자주 쓰인다.

## 4.5 커서

**데이터베이스는 커서를 사용해 find의 결과를 반환한다.**

셸에서 커서를 생성하려면 컬렉션에 도큐먼트를 집어넣고 쿼리한 후 결과를 지역 변수에 할당한다.

### 제한, 건너뛰기, 정렬

결과 개수를 제한하려면 `find` 호출에 `limit` 함수를 연결한다.

### 데이터형 정렬 순서

1. 최솟값
2. null
3. 숫자
4. 문자열
5. 객체/도큐먼트
6. 배열
7. 이진 데이터
8. 객체 ID
9. boolean
10. 날짜
11. 타임스탬프
12. 정규 표현식
13. 최댓값

### 많은 수의 건너뛰기 피하기

`skip`은 생략된 결과물을 모두 찾아 폐기하므로 결과가 많으면 느려진다.
특정 페이지의 마지막 데이터의 기준점을 찾아 비교연산자를 사용하자.

### 종료되지 않는 커서

커서는 클라이언트가 보는 커서, 클라이언트 커서가 나타내는 데이터베이스 커서 두 가지 측면이 있다.
서버 측에서 커서는 메모리와 리소스를 점유한다. 커서가 더는 가져올 결과가 없거나 종료 요청을 받으면 데이터베이스는 점유하고 있던 리소스를 해제한다.

**서버 커서를 종료하는 조건**

1. 조건에 일치하는 결과를 모두 살펴봄
2. 커서가 클라이언트 측에서 유효 영역을 벗어남
3. 10분 동안 아무런 활동이 없음

일반적으로 `타임아웃에 의한 종료`는 바람직한 동작이다. 커서의 타임아웃을 비활성화했다면 반드시 결과를 모두 살펴보거나 커서를 명확히 종료해야 한다.
