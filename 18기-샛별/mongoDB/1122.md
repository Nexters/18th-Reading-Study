# 3장. 도큐먼트 생성, 갱신, 삭제

## 3.1 도큐먼트 삽입

- **삽입**은 몽고DB에 데이터를 추가하는 기본 방법
- 따로 추가하지 않으면 "_id" 키가 추가되고 도큐먼트가 DB에 저장된다.

### insertMany

- `insertMany` : 도큐먼트 배열을 데이터베이스에 전달
- 여러 도큐먼트를 단일 컬렉션에 삽입할 때 유용함
- 책 기준 버전에서 48메가바이트보다 큰 메시지를 허용하지 않으므로 일괄 삽입이 가능한 데이터 크기에 제한이 있음
- 몽고DB는 한번의 호출로 여러 작업을 일괄 처리하는 대량 쓰기 API를 지원함

### 삽입 유효성 검사

- 몽고DB는 삽입된 데이터에 최소한의 검사 수행
- "_id" 필드가 존재하지 않으면 새로 추가, 모든 도큐먼트가 16MB보다 작은지 검사

### 삽입

- 3.0 이전 버전 : `insert`를 주로 사용
- 현재 : `insertOne`, `insertMany`

## 3.2 도큐먼트 삭제

- `deleteOne` & `deleteMany`
- 두 메서드 모두 필터 도큐먼트를 첫 번째 매개변수로 사용
- `deleteOne` : 필터와 일치하는 첫 번째 도큐먼트 삭제 (어떤 도큐먼트가 첫 번째일지는 요인에 따라 달라짐)
- `deleteMany` : 필터와 일치하는 모든 도큐먼트 삭제
- 일반적으로 도큐먼트 제거 작업은 빠르다

## 3.3 도큐먼트 갱신

- `updateOne`, `updateMany` : 첫 번째 매개변수로 필터, 두 번째 매개변수로 수정자 도큐먼트
- `replaceOne` : 첫 번째 매개변수로 필터, 두 번째 매개변수로 필터와 일치하는 도큐먼트를 교체할 도큐먼트

갱신은 **원자적으로 이루어진다.** 갱신 요청 두 개가 동시에 요청하면 서버에 먼저 도착한 요청이 적용된 후 다음 요청이 적용된다.

> 기본 동작을 원치 않으면 도큐먼트 버저닝 패턴을 고려하자.

### 도큐먼트 치환

`replaceOne`은 도큐먼트를 새로운 것으로 완전히 치환한다. 이는 대대적인 스키마 마이그레이션에 유용하다.

흔히 하는 실수는 조건절로 2개 이상의 도큐먼트가 일치되게 한 후 두 번째 매개변수로 중복된 "_id" 값을 갖는 도큐먼트를 생성하는 경우가 있다. 이때 데이터베이스는 오류를 반환하고 아무것도 변경하지 않는다. -> *"_id"키로 일치하는 고유한 도큐먼트를 찾아 갱신 대상으로 지정하는 것이 좋다.*

"_id" 값은 컬렉션 기본 인덱스 기초를 형성하므로 필터에서 사용해도 효율적이다.

### 갱신 연산자

일반적으로 도큐먼트 특정 부분만 갱신하는 경우가 많다. **부분 갱신에는 `원자적 갱신 연산자`를 사용한다.**

- 연산자를 사용할 때 "_id" 값은 변경할 수 없다.
- 키를 추가, 변경, 삭제할 때는 항상 $ 제한자를 사용한다.

#### 배열의 위치기 기반 변경

- 몽고DB에서는 쿼리 도큐먼트와 일치하는 배열 요소 및 요소의 위치를 알아내서 갱신하는 **위치 연산자 "$"**를 제공
- 위치 연산자는 첫 번째로 일치하는 요소만 갱신

#### 배열 필터를 이용한 갱신

- 3.6 버전부터 `arrayFilters`를 도입해 특정 조건에 맞는 배열 요소 갱신 가능

### 갱신 입력

**갱신 입력**은 특수한 형태를 갖는 갱신이다. 갱신 조건에 맞는 도큐먼트가 존재하지 않을 때는 쿼리 도큐먼트와 갱신 도큐먼트를 합쳐서 새로운 도큐먼트를 생성한다. 조건에 맞는 도큐먼트가 발견되면 일반적인 갱신을 수행한다.

#### 저장 셸 보조자

- `save`는 도큐먼트가 존재하지 않으면 도큐먼트를 삽입하고, 존재하면 도큐먼트를 갱신하게 하는 셸 함수
- 개발자가 셸에서 도큐먼트를 빠르게 수정하게 하는 편리한 함수

### 다중 도큐먼트 갱신

- `updateMany`를 이용해 여러 도큐먼트의 값 갱신
- 3.2 버전부터는 `FindOneAndDelete`, `FindOneAndReplace`, `FindOneAndUpdate` 세 개의 컬렉션 메서드가 도입
- 4.2 버전에서는 갱신을 위한 집계 파이프라인을 수용하도록 `FindOneAndUpdate` 확장
  - 파이프라인은 `$addField`, `$project`, `$replaceRoot`로 구성
