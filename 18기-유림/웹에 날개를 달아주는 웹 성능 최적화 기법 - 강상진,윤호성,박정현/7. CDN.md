> p241-276

### 7. CDN



**CDN을 사용하는 이유**

서버 용량은 서비스 가용성 및 안정성에 큰 영향을 미친다. 이를 해결할 쉬운 방법은 

첫번째로 기존 서버의 용량을 증설하는 것이다. 비용이 들지만 기존 아키텍처를 크게 변경하지 않는다. 하지만 원본 사용자와 해외 사용자들 간 지리적 위치가 멀어서 로딩 속도를 보장하기 어렵다.

두번째로 해외에 직접 데이터 센터를 구축한다. 막대한 예산 투입. 철저한 시장 조사와 수요 예측 필요. 복잡한 아키텍처 설계.

세번째 해외에 있는 호스팅 서버 이용. 많은 비용 절감, 하지만 원본 앱 수정, 테스트 및 배포에 대한 계획을 꼼꼼히 세워야 함. 동기화 이슈.

반면에 CDN은 성능 및 안전성을 보장하며 아키텍처를 특별히 변경하지 않아도 된다. 가격이 저렴함.

동적 콘텐츠 가속이 가능하고, 프런트엔드 최적화, 동영상 라이브 스트리밍 서비스에 유용, 클라우드 보안이 특징.



**CDN 서비스 아키텍처**

CDN 서비스는 리버스 프록시 서버 형태로 존재한다. 웹 캐시 서버의 아키텍처와 유사하다. 캐시된 콘텐츠들을 최종 사용자에게 빠르게 전달하기 위해서는 사용자와 가까운 곳에 서버가 위치해야 하므로, CDN 업체들은 많은 곳에 많은 서버들을 배치한다. 이를 **에지 서버** 라고 부르며 업체들은 여러 개의 POP을 만들어 에지 노드들을 구성한다.



**CDN 동작 방법**

일반적으로

브라우저 url 입력 -> DNS 웹 사이트 IP 주소 조회 -> 도메인 네임 조회 -> IP 주소로 콘텐츠 요청. (RTT)

CDN 사용하면

url 입력 -> IP 주소 조회 -> CDN 서비스 제공자의 도메인명 반환 -> 도메인 네임 조회 -> 가까이 위치한 에지 서버 IP로 콘텐츠 요청 -> 캐시되지 않은 경우 원본 서버에서 받아와서 브라우저에 응답



**CDN 적용 방법**

1. 원본 서버로 사용할 호스트명과 IP를 네임 서버의 A 레코드로 추가한다.
2. CDN 설정에 원본 서버의 호스트명 등록
3. 도메인명에 부여돼있던 IP정보를 CDN 서비스 제공자의 도메인명으로 변경



**다중 캐시 전략**

캐시 축출: 정해진 우선순위에 따라 낮은 순위의 콘텐츠를 삭제한다.

롱테일 콘텐츠: 생성 초기 많이 조회되다가 시간이 흐르면 거의 조회되지 않는 콘텐츠 -> 축출



**캐시 서버 간 캐시 콘텐츠 공유**

에지 서버 간 캐시 공유는 ICP 같은 특별한 프로토콜을 사용해 빠르게 이루어져야 한다. 따라서 동일한 백본 네트워크에 연결된 서버 사이에서 이루어진다. 일반적으로 동일한 POP 서버들은 캐시된 콘텐츠를 서로 공유할 수 있다.



**다중 계층 캐시**

에지 서버들과 원본 서버 사이에 추가 캐시 서버 계층을 두어 같은 콘텐츠를 여러 번 캐시하는 방식.

1. 부모 계층은 원본 서버에 가까이 존재해야 하고
2. 부모 계층의 캐시 서버 수가 자식 계층의 캐시 서버 수보다 훨씬 적어야 한다.

과도한 트래픽으로부터 원본 서버 보호 가능

사용자 요청에 대한 응답 속도 향상



**전달 경로 최적화**

현재 CDN 업체들은 콘텐츠 캐시뿐만 아니라 애플리케이션 가속 서비스를 동시에 제공한다. 모바일 앱 중요성이 강조되면서 API 호출이 속도를 증가시키는 해결책으로 각광받고 있다. 전달 경로 최적화는 API 호출 같은 동적 데이터뿐만 아니라 캐시가 만료된 콘텐츠를 원본에서 다시 불러올 때도 필요한 기능이다.

전달 경로를 최적화할 때 경로를 라스트 마일, 미들 마일, 퍼스트 마일 세 구간으로 나눈다.

라스트 마일: 최종 사용자와 CDN 에지 서버 간 구간
미들 마일: CDN 네트워크 구간
퍼스트 마일: 에지 서버와 원본 서버와의 구간



**라스트 마일 최적화**

최종 사용자 요청을 사용자와 가장 가까운 곳에 있는 에지 서버로 전송하는 일이다.

- DNS 기반 에지 선택

에지 서버들의 상태와 네트워크 상황을 모니터링하고 있다가 DNS 서버로 특정 웹 사이트 도메인명에 대한 쿼리가 요청되면 사용자의 로컬 DNS와 가장 가깝고 사용량이 적은 에지 서버의 IP를 반환한다.

DNS쿼리에는 사용자 기기의 IP정보가 포함되지는 않는다. 대신 사용자의 로컬 DNS IP정보를 활용해 위치를 짐작할 수 있다. 하지만 실사용자의 IP정보가 아닌 인터넷 서비스 제공자의 DNS 서버 위치 정보이므로 사용자가 특정 DNS 서버를 지정해 사용하는 경우 엉뚱한 곳의 에지 서버가 선택될 수 있다. 실제로 최근 구글 public DNS 또는 open DNS를 사용하고 있다.

- 애니캐스트 기반의 에지 선택

데이터를 전송하는 여러 방식 중 유니캐스트 방식을 흔하게 사용한다. 

유니캐스트: 보내는 측과 받는 측이 1:1로 통신하는 방식, 보내는 측은 받는 측 주소를 정확히 알고 메시지를 전송해야 한다.
멀티캐스트: 1:N 통신 방식, 보내는 측은 받는 노드들의 그룹 주소 또는 포트를 알고 있어야 한다. - 클러스터 환경에서 관리 노드가 자식 노드들을 관리할 때 흔히 사용하는 방법.
브로드캐스트: N:N, 불특정 다수에게 메시지를 전송하는 방식으로 메시지를 받을지 말지는 수신자가 결정한다.

애니캐스트 역시 네트워크상에서 원하는 IP주소로 데이터를 전송하는 방식 중 하나.

1:1 전송 방식이지만, 유니캐스트와는 다르게 다수 노드가 같은 IP주소를 가진다. 보내는 측이 그 IP주소로 메시지를 보낼 때 네트워크상 가장 가까운 노드를 선택해 전송한다. 보내는 측의 라우터와 경계 경로 프로토콜에 의해 전송될 노드가 결정된다.

에지 선택 방식에서 모든 에지에 동일 IP를 부여하거나 지역별 클러스터를 만들어 클러스터마다 IP를 부여한다.

사용자 브라우저가 웹 사이트에 도메인명에 대한 IP를 요청 -> CDN의 DNS 서버가 사용자에게 가장 가까운 지역의 IP를 반환 -> 브라우저가 그 IP에 HTTP 요청을 보내면 애니캐스트 방식에 의해 가장 가까운 에지 서버가 요청을 처리

실제 사용자와 지리적으로 가장 가까운 에지 선택을 보장하지는 않는다. BGP가 ISP정책에 따른 경로를 선택하기 때문. 저비용과 고효율에 기반하여 결정되므로 ISP간 계약 관계에 따라 최적 경로가 결정된다. 이를 **네트워크적으로 가장 가깝다**고 표현한다.



라스트 마일 구간에서 최적의 에지 서버를 찾았다면, 퍼스트 마일에서는 최적의 원본 서버를 찾아야 한다. 오직 하나의 데이터 센터를 운영하는 웹 사이트라면 퍼스트 마일 구간의 경로 최적화가 크게 효과적이지 않다. 하지만 다수 데이터센터를 통해 고가용성을 유지하고자 한다면 상황에 따라 적절한 데이터 센터를 찾아 사용자 요청을 전달하고 응답을 받는 것이 중요하다.

요청이 어떤 하나의 데이터 센터에서 처리될 때 이어지는 요청들도 모두 똑같은 데이터 센터에서 처리되어야 한다. 웹 사이트를 사용하는 동안 사용자의 로그인 세션이 끊기지 않도록, 이를 위해 CND에서는 사용자 쿠키에 선택된 데이터 센터의 정보를 넣어 동일 사용자 요청은 동일 센터로 전송되도록 한다.



미들 마일 전달 경로 최적화는 사용자 요청을 받은 에지 서버와 원본 서버 간 가장 빠른 네트워크 경로를 찾아내는 작업이다. CDN 제공자들은 각 나라의 대표적인 ISP 데이터 센터 또는 POP 내에 자사의 에지 노드들을 구축해 언제든 우회 경로를 생성할 수 있는 환경을 만든다. 이 알고리즘은 업체마다 다르다.



**프로토콜 최적화**

경로 최적화가 빠른 길을 찾는 과정이라면, 프로토콜 최적화는 한번에 많은 트래픽을 보낼 수 있도록 길을 넓히는 작업이다.

웹에서 요청 및 응답을 빠르게 전달하려면 한번에 가능한 많은 패킷을 보내는 것이 유리하다. 받는 측이 모두 수용할 수 있는 것은 아니다. 이 경우 유실되는 데이터를 다시 전송해야 하므로 네트워크 자원을 낭비한다. 때문에 받는 측은 윈도우 사이즈(RWIN), 수신 가능한 데이터 크기를 서버에 통지한다. 보내는 측은 이보다 더 적은 양의 데이터를 보내야 한다.

- TCP 최적화

느린 시작: 적은 양의 데이터부터 전송하는 것. 이렇게 전송하는 데이터의 크기를 혼잡 윈도우라고 한다.

1. 초기 혼잡 윈도우에 정해진 만큼 데이터 패킷을 전송한다.
2. 문제가 없으면 혼잡 윈도우 값은 제곱으로 증가한다.
3. 네트워크가 혼잡해 재전송 타임아웃(RTO)이 발생하면 현재 혼잡 윈도우의 절반 값으로 임계치가 설정되고 처음부터 다시 전송한다.
4. 이후 혼잡 윈도우 값이 정해진 임곗값보다 커지면 혼잡 회피를 위해 혼잡 윈도우 값은 제곱이 아닌 선형으로 증가한다.
5. 이후 임곗값은 패킷 유실이나 네트워크 에러, 중복 응답 등에 따라 다른 방식으로 계산되어 정해진다.

CDN에서는 먼저 미들 마일의 네트워크가 잘 관리되고 양호하다는 전제가 있어야 한다. 이 전제 하에서,

1. 초기 혼잡 윈도우 값을 늘려 한 번에 많은 데이터 패킷을 보낼 수 있게 한다.
2. RTO 값을 낮춰 실패한 패킷을 빠르게 재전송한다. 일반적 TCP 환경에서는 네트워크 혼잡에 의한 RTO 값이 수 분까지 길어질 수 있다. 수신 측까지의 네트워크의 일시적 문제로 패킷이 전송되지 못했을 때도 서버는 몇 분 이상 기다려야 이 상황을 인지하고 재전송한다.

이러한 이론은 퍼스트 마일에서도 적용할 수 있고, 데이터를 송신하는 측이 원본 서버가 된다.

혼잡 윈도우를 늘리면 네트워크 트래픽이 갑작스럽게 증가하는 현상이 생길 수 있으니 CDN 담당자, 네트워크 담당자와 충분히 상의한 후 결정해야 한다.



**기타 성능 옵션**

**CDN이 대신 제공하는 기본 기능**

웹 애플리케이션으 설계하고 구축하는 과정에서 최적화 과정을 간과한다. 소스 코드 외에 웹 서버와 웹 프로토콜 등의 웹 아키텍처 최적화는 미처 생각하지 못해 누락하는 경우도 있다. 웹 호스팅 서버에서도 쉽게 구현할 수 있다. 그러나 CDN에서도 관련 기능을 제공한다.

- HTTP 압축

gzip으로 압축, Apache에서는 mod_deplate 모듈을 추가하고 압축 대상 파일 확장자들의 압축 설정을 추가하면 된다.

CDN 사용 중이라면 기본적인 테스트 파일 포맷에 gzip 압축을 적용해 브라우저로 전송할 것이다.

? 하지만 에지 서버와 브라우저 네트워크 구간에만 적용되므로, 서버 측에서 압축 설정을 해야 한다.

- 브라우저 캐시

CDN에서는 콘텐츠 캐시 주기를 별도로 설정한다. 서버에서 max-age, expire 헤더를 사용할 필요가 없다.

- HTML, CSS, JS 최소화

텍스트 파일 사이즈를 줄이는 것은 쉬운 최적화 방법 중 하나이다. 에지 서버에서 공백, 주석 등을 제거해 캐시한다.

- DNS 프리페치와 프리커넥트

리소스를 다운로드할 도메인이 많은 경우 미리 도메인명의 IP를 찾으면 브라우저가 실제로 해당 리소스를 다운로드하는 시점에 IP 검색 시간을 줄일 수 있다. 페이지를 보다 빠르게 로딩할 수 있다. 

HTTP 응답에 Link 헤더를 추가해 도메인 IP를 미리 조회한다. TCP 연결까지 미리 생성하는 프리커넥트를 추가한다.



**신기술 적용을 위한 CDN 기능**

- HTTP/3

- 서버 푸시

1 CDN에 푸시할 자원들을 미리 지정 - 푸시 객체를 변경하거나 페이지별로 대상이 다르면 각각 설정해야 한다.

2 웹 페이지에 푸시할 리소스를 태그로 지정 - 적어도 한 번은 원본 서버에 다녀와야 하므로 시간 지연이 발생

- IPv6 듀얼 스택

IPv6의 장점이 많지만 기업 네트워크 인프라스트럭처를 전환하는 것은 간단하지 않기 때문에, 여전히 많은 웹 사용자들이 IPv4를 사용하고 있다. CDN을 사용하면 IPv6의 장점을 경험해볼 수 있다.

