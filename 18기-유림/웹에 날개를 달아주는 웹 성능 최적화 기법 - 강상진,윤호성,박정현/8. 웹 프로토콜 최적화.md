> p277-289

### 8. 웹 프로토콜 최적화



**HTTP의 발전**

HTTP/1.0부터는 HTTP 페이로드 외에도 헤더를 통해 클라이언트와 서버의 정보를 전달할 수 있었다. Content-Type 헤더를 이용해 이미지나 동영상 등 다양한 정보를 주고받았다. POST 메소드로 웹 서버로 클라이언트 정보를 전달했다. Content-Encoding 헤더를 통해 클라이언트 서버 간 압축 정보를 공유하며 HTML 등의 스크립트를 압축해 크기를 줄여 전송하고 클라이언트는 이를 압축 해제해 브라우징 했다.



**HTTP/1.1**

HTTP의 첫 번째 공식 표준 버전이다. PUT, DELETE를 이용해 파일을 업로드, 삭제했다. Via 헤더를 사용해 중계 서버 정보를 공유하고 Accept 헤더로 클라이언트가 어떤 형식의 콘텐츠를 지원하는지 미리 서버에 알려줬다. 하나의 TCP 연결을 재사용해 많은 콘텐츠를 전달할 수 있는 지속적 연결 기술이 추가됐다.

또 파이프라이닝 기술이 생겼다. 브라우저가 웹 서버에 여러 콘텐츠를 요청했을 때, 이전 응답을 완전하게 받지 못해도 지속적 연결로 확보한 하나의 TCP 연결 내에서 미리 다음 요청에 대한 처리를 시작하면서 전체적인 전달 시간을 줄이는 방식이다.

문제점은? 통신에는 순서가 있다. 어떤 요청이 지연되면 나머지 요청도 지연된다. 이것을 HOL(Head Of Ling blocking) 문제라고 한다.



**HTTP/2**

HTTP/2의 전신 기술은 개선된 웹 프로토콜을 만들기 위해 구글이 시작한 SPDY 프로젝트이다. 텍스트 방식의 프로토콜 메시지를 버리고 이진 포맷을 사용하면서 프로토콜 자체를 경량화 시도했다.

멀티플렉싱, 스트림 우선순위 설정, 헤더 압축, 서버 푸시같은 새로운 프로토콜 최적화 기능이 추가되었다. HOT의 문제를 해결할 수 있었지만 TCP의 HOL 문제는 해결하지 못했다.



**HTTP/3**

새로운 인터넷 프로토콜인 QUIC를 사용하는 HTTP 최상위 버전이다. QIC의 가장 큰 특징은 UDP(User Datagram Protocol) 사용이다. UDP 프로토콜 구조는 최적화를 진행하기 더 쉬운 형태이다. 클라이언트와 HTTP/3 서버 사이에 한 번 맺은 QUIC 연결을 최대한 재사용하는 구조이다. 연결을 만드는 과정에서 소모되는 시간이 대폭 줄어들었다. 가장 최근 버전.



**HTTP/2의 최적화 기술**

클라이언트 <-> 서버 간 콘텐츠를 주고받는 시간을 줄이고, 서버 응답이 느린 콘텐츠가 다른 정상적인 콘텐츠의 전달을 방해하지 않도록 하는 것.

기존 문자열 방식의 프로토콜을 이진 프레임으로 바꿨다. HTTP 요청과 응답에 중복 헤더 값은 걸러내고, 전송해야 하는 값을 압축해 헤더 크기를 최소화했다. 서버 푸시를 통해 요청하지 않은 콘텐츠도 미리 빠르게 전송하여 RTT를 최소화했다.

이 SPDY 프로토콜에서 시작된 기술들은 최대 55% 빠른 웹을 만들 수 있었다.



**이진 프레임**

이전에 HTTP의 요청과 응답은 메시지라는 단위로 구성되어 있었다. HTTP의 메시지는 상태 라인, 헤더와 페이로드로 이루어져 요청과 응답에 필요한 정보를 담고 있다. curl을 통해 메시지 구성을 확인할 수 있다.

HTTP/2에는 기존 버전의 메시지 단위 외에도 프레임, 스트림이라는 단위가 추가되었다.

- 프레임: 통신상 제일 작은 정보 단위이며 헤더나 데이터 중하나
- 메시지: 요청 혹은 응답 단위이며 다수의 프레임으로 이루어짐
- 스트림: 클라이언트와 서버 사이 맺어진 연결을 통해 양방향으로 주고받는 단,복수의 메시지

프레임 -> 메시지 -> 스트림이 되는 구조. 스트림에는 고유 번호가 있는데 하나의 요청이 스트림으로 보내지면 그 응답은 요청 스트림과 같은 스트림 번호를 가진다. 이 번호로 어떤 요청에 대한 응답인지 구분한다.

하나의 스트림이 다수의 요청을 포함하고 이에 대한 다수의 응답 정보를 포함하는 구조로 바뀌었다. 스트림의 유연한 구조 덕분에 서버에서 만들어지는 응답 프레임들이 요청 순서에 상관없이 만들어진 순서대로 클라이언트에게 전달된다. 즉 하나의 TCP 연결을 통해 다수의 클라이언트 요청과 서버 응답이 비동기 방식으로 이루어지는 멀티플렉싱이 사용된다. HOL 문제가 자연스레 해결됐다. 또, 크기가 크거나 처리가 오래 걸리는 콘텐츠를 전달할 때의 병목 현상도 피할 수 있게 됐다.



**헤더 압축**

클라이언트와 서버 사이에 가상 테이블을 만들어서 동일하고 중복되는 헤더 값들을 테이블에 저장하고 참고하는 방식을 사용해 중복 전달을 제거했다.

정적 테이블에는 미리 정의된 자주 사용되는 헤더 필드를 저장한다. 동적 테이블에는 통신하며 주고받는 값들을 업데이트한다. 각 테이블에는 인덱스 번호가 있는데, 동일한 값은 이 번호로 대체하여 보낸다.

헤더 압축 알고리즘인 HPACK을 사용해 허프만 알고리즘 방식으로 좀 더 경량의 데이터를 주고받을 수 있게 됐다. 자주 등장하는 값과 그렇지 않은 값마다 코드 값을 다르게 부여하는 알고리즘이다. 



**서버 푸시**

클라이언트의 요청이 없어도 서버가 여러 응답을 알아서 보내는 것을 말한다. 특정 컨텐츠 요청 이후 추가될 요청을 미리 요청하고 응답하는 것을 의미한다.

일반적으로 HTML을 호출한 후 CSS, JS, Img 파일 대상이 고정돼있다면 웹 서버에 서버 푸시 대상으로 미리 설정할 수 있다. 최근의 APM(Application Performance Management) 솔루션들은 서버 푸시 대상을 자동으로 설정해 주는 기능을 포함한다. 웹 페이지의 구조와 호출하는 후속 파일 대상이 변경되어도 이를 탐지하고 적용할 수 있다.



**HTTP/3의 최적화 기술**

................





**프로토콜 최적화**

경로 최적화가 빠른 길을 찾는 과정이라면, 프로토콜 최적화는 한번에 많은 트래픽을 보낼 수 있도록 길을 넓히는 작업이다.

웹에서 요청 및 응답을 빠르게 전달하려면 한번에 가능한 많은 패킷을 보내는 것이 유리하다. 받는 측이 모두 수용할 수 있는 것은 아니다. 이 경우 유실되는 데이터를 다시 전송해야 하므로 네트워크 자원을 낭비한다. 때문에 받는 측은 윈도우 사이즈(RWIN), 수신 가능한 데이터 크기를 서버에 통지한다. 보내는 측은 이보다 더 적은 양의 데이터를 보내야 한다.

- TCP 최적화

느린 시작: 적은 양의 데이터부터 전송하는 것. 이렇게 전송하는 데이터의 크기를 혼잡 윈도우라고 한다.

1. 초기 혼잡 윈도우에 정해진 만큼 데이터 패킷을 전송한다.
2. 문제가 없으면 혼잡 윈도우 값은 제곱으로 증가한다.
3. 네트워크가 혼잡해 재전송 타임아웃(RTO)이 발생하면 현재 혼잡 윈도우의 절반 값으로 임계치가 설정되고 처음부터 다시 전송한다.
4. 이후 혼잡 윈도우 값이 정해진 임곗값보다 커지면 혼잡 회피를 위해 혼잡 윈도우 값은 제곱이 아닌 선형으로 증가한다.
5. 이후 임곗값은 패킷 유실이나 네트워크 에러, 중복 응답 등에 따라 다른 방식으로 계산되어 정해진다.

CDN에서는 먼저 미들 마일의 네트워크가 잘 관리되고 양호하다는 전제가 있어야 한다. 이 전제 하에서,

1. 초기 혼잡 윈도우 값을 늘려 한 번에 많은 데이터 패킷을 보낼 수 있게 한다.
2. RTO 값을 낮춰 실패한 패킷을 빠르게 재전송한다. 일반적 TCP 환경에서는 네트워크 혼잡에 의한 RTO 값이 수 분까지 길어질 수 있다. 수신 측까지의 네트워크의 일시적 문제로 패킷이 전송되지 못했을 때도 서버는 몇 분 이상 기다려야 이 상황을 인지하고 재전송한다.

이러한 이론은 퍼스트 마일에서도 적용할 수 있고, 데이터를 송신하는 측이 원본 서버가 된다.

혼잡 윈도우를 늘리면 네트워크 트래픽이 갑작스럽게 증가하는 현상이 생길 수 있으니 CDN 담당자, 네트워크 담당자와 충분히 상의한 후 결정해야 한다.



**기타 성능 옵션**

**CDN이 대신 제공하는 기본 기능**

웹 애플리케이션으 설계하고 구축하는 과정에서 최적화 과정을 간과한다. 소스 코드 외에 웹 서버와 웹 프로토콜 등의 웹 아키텍처 최적화는 미처 생각하지 못해 누락하는 경우도 있다. 웹 호스팅 서버에서도 쉽게 구현할 수 있다. 그러나 CDN에서도 관련 기능을 제공한다.

- HTTP 압축

gzip으로 압축, Apache에서는 mod_deplate 모듈을 추가하고 압축 대상 파일 확장자들의 압축 설정을 추가하면 된다.

CDN 사용 중이라면 기본적인 테스트 파일 포맷에 gzip 압축을 적용해 브라우저로 전송할 것이다.

? 하지만 에지 서버와 브라우저 네트워크 구간에만 적용되므로, 서버 측에서 압축 설정을 해야 한다.

- 브라우저 캐시

CDN에서는 콘텐츠 캐시 주기를 별도로 설정한다. 서버에서 max-age, expire 헤더를 사용할 필요가 없다.

- HTML, CSS, JS 최소화

텍스트 파일 사이즈를 줄이는 것은 쉬운 최적화 방법 중 하나이다. 에지 서버에서 공백, 주석 등을 제거해 캐시한다.

- DNS 프리페치와 프리커넥트

리소스를 다운로드할 도메인이 많은 경우 미리 도메인명의 IP를 찾으면 브라우저가 실제로 해당 리소스를 다운로드하는 시점에 IP 검색 시간을 줄일 수 있다. 페이지를 보다 빠르게 로딩할 수 있다. 

HTTP 응답에 Link 헤더를 추가해 도메인 IP를 미리 조회한다. TCP 연결까지 미리 생성하는 프리커넥트를 추가한다.



**신기술 적용을 위한 CDN 기능**

- HTTP/3

- 서버 푸시

1 CDN에 푸시할 자원들을 미리 지정 - 푸시 객체를 변경하거나 페이지별로 대상이 다르면 각각 설정해야 한다.

2 웹 페이지에 푸시할 리소스를 태그로 지정 - 적어도 한 번은 원본 서버에 다녀와야 하므로 시간 지연이 발생

- IPv6 듀얼 스택

IPv6의 장점이 많지만 기업 네트워크 인프라스트럭처를 전환하는 것은 간단하지 않기 때문에, 여전히 많은 웹 사용자들이 IPv4를 사용하고 있다. CDN을 사용하면 IPv6의 장점을 경험해볼 수 있다.

