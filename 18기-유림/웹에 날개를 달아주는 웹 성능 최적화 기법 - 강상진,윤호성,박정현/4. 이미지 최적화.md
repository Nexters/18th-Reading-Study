> p91-144

### 4. 이미지 최적화

고해상도 디스플레이의 발전하면서 TV로도 웹페이지를 볼 수 있게 됐다. 해상도는 Full HD, 4K UHD를 넘어 5K까지 개발됐다. 화소 밀도 또한 2x, 3x 등으로 점차 증가하고 있다. 흔히 우리가 4K라고 부르는 모니터의 해상도는 3,840X2,160 정도의 크기를 지칭한다.



**화소 밀도**

물리 스크린 공간 안에 얼마나 많은 픽셀이 압축되어 있는가를 의미한다. 1x, 2x와 같은 기기 픽셀 비율(Device Pixel Ratio, DPR)로 표현한다. 이는 단위 길이 안에 존재하는 픽셀의 개수를 상대적으로 나타내는 단위이다.

모니터나 TV의 화소 밀도는 보통 인치당 픽셀 개수인 PPI(Pixel Per Inch)로 표현한다. 같은 1인치 안에 픽셀 수가 많으면 많을수록 화소 밀도가 높으며, 화소 밀도가 높을수록 더 선명한 화면을 표현할 수 있다.

웹 이미지의 크기를 얘기할 때 포인트라는 용어를 사용하기도 한다. 40픽셀 이미지는 말 그대로 40픽셀의 너비를 가진 이미지 하나를 의미한다. 그러나 40포인트 이미지는 1x에서는 40픽셀, 2x에서는 80픽셀, 3x에서는 120픽셀의 너비를 가진 이미지를 뜻한다. 따라서 하나의 이미지를 사용할 때도 디스플레이를 고려해 여러 크기의 이미지들을 모두 준비해야 하므로 훨씬 더 많은 노력이 필요하다.

이러한 이미지의 특성은 웹 사이트의 성능에서 가장 중요한 역할을 한다. 사용자가 사이트에 처음 접속해서 보는 가장 크고 특색있는 이미지를 Hero 이미지 또는 대문 이미지라고 한다. 이 Hero를 보는 순간 나머지 리소스들을 기다릴 여유가 생긴다. 하지만 이 이미지가 로딩되지 않으면 이탈할 확률이 높다.

여기서 고민할 점이 고품질 이미지를 그대로 사용하면 웹 성능 문제로 불만이 발생할 수 있다. 



**디지털 이미지의 종류와 특성**

이미지의 종류와 특성을 파악하고 사용될 기기 타입과 용도에 맞춰 적절한 이미지를 선택해야 한다.

데스크톱용 이미지보다 모바일용 이미지의 무게가 더 무거운 이유는, 모바일 이미지에 png 타입을 사용하기 때문이다. png 파일은 알파 채널이라는 이미지 변환 기법을 사용한다. 핵심 이미지 레이어를 제외한 배경 이미지 레이어를 제거하여 전체 이미지를 투명하게 만들어 사용하는 것이 장점이다. 하지만 같은 품질의 jpeg 대비 파일 사이즈가 커지는 단점이 있다. 따라서 투명 기능이 필요하지 않으면 jpeg 타입으로 변환해 사용하는 것이 사이트의 성능을 위한 더 나은 선택이다.



**래스터 이미지 vs 벡터 이미지**

디지털 이미지는 일반적으로 디지털 화면에 이미지들을 어떻게 표현하는지에 따라 래스터 이미지와 벡터 이미지로 분류한다. 

래스터 이미지는 우리가 사용하는 대부분의 이미지 유형이며, 작은 사각형 모양의 픽셀에 표현하고자 하는 색상 정보를 입력해 이를 컴퓨터로 표현한다. 각각의 픽셀들이 모여 큰 이미지를 완성한다. 확장성이 떨어진다.

벡터 이미지는 그리고자 하는 대상의 수학적인 정보를 제공한다. 위치할 좌표, 원, 사각형 등의 형상, 크기, 색상 등의 정보를 제공하여 마치 그림을 그리듯 화면에 표현한다. svg파일이 w3c 표준 포맷으로 많이 사용된다. 화면 스케일에 상관없이 항상 선명한 이미지를 표현할 수 있다. 하지만 그림이 복잡해지면 표현할 정보가 기하급수적으로 늘어나며 수학적 정보로 표현하는 데 많은 제약이 있다.



**무손실 이미지 형식 vs 손실 이미지 형식**

원본 이미지의 정보 손실을 허용하지 않으면 무손실 이미지라고 한다. 

gif
사용할 수 있는 색이 256컬러(8bit)로 매우 제한적, 단순한 형태의 이미지 표현에 적합

png
24비트 색상(2^24, 16777216), 알파 채널(투명) - 이미지 백그라운드 투명도를 조절해 하나의 이미지에 여러 배경을 바꾸어 다양하게 조합 가능.
필요에 따라 이동할 수 있는 형태를 만들기 위해 정보 손실을 어느 정도 허용하면 손실 이미지라고 한다. jpeg, webp 같이 브라우저에 특화된 이미지 유형들

jpeg
디지털 카메라로 만들어지는 RAW 형식 파일을 브라우저에 게시하기 위해 개발한 이미지 형식, 사람의 눈이 인식할 수 있는 색상만 남기고 나머지를 제거한다.
동일한 이미지를 여러 번 편집해야 하는 경우 비트맵이나 png처럼 무손실 이미지 파일을 사용하고, 편집을 완료하면 jpeg로 저장

webp
구글 크롬 시장 점유율을 보면 영향력이 큼을 짐작할 수 있다. 무손실 압축, 애니메이션, 투명 기능을 모두 지원.
사용자의 네트워크 품질이 낮은 경우를 고려한다면 점진적 데이터 전송 기능이 빠진 점이 아쉽다.



**이미지 변환 기법**

무손실 압축을 하려면 각 이미지 유형을 다르게 처리해야 한다. 대체로 스크립트를 통해 압축을 자동화할 수 있다. 무료로 배포되는 라이브러리의 명령어를 이용해 자동화한다.

손실 압축은 특정 이미지 정보를 누락, 손실시킨다. 사용자는 실제 눈치채지 못할 확률이 높다. 손실 압축은 원하는 만큼의 화질을 얻지 못하므로 고화질의 사진을 저장해 감상해야 한다면 적합하지 않다. 하지만 웹상에 게시하고자 한다면 성능과 화질 사이 득실을 따져봐야 한다.

대부분 웹 사용자들은 약간의 화질 차이보다는 이미지 로딩 속도에 민감하게 반응한다. 대개 이미지에 따라 손실 압축 비율이 달라진다. 필자는 85~80% 정도 품질의 이미지 손실 압축을 권장한다.

```
// ImageMagick
$ convert input.jpg -quality 80 output.jpg
```

손실 압축을 위한 최적의 품질 지수를 찾기 위해서는 원본 이미지와 손실 압축 이미지의 시각적 차이를 정량 계산할 수 있는 방법이 필요. 대표적인 알고리즘은 다음과 같다.

- 평균 제곱 오차
- 최대 신호 대 잡음 비
- 구조적 유사도 (SSIM)



**반응형 웹에서의 이미지 배치 전략**

모바일 기능이 나날이 발전하고 이용자 수가 증가한다. 급기야 모바일 인터넷 접속 트래픽이 데스크톱과 유선 인터넷 접속 트래픽을 앞질렀다.

처음에는 m.(엠닷) 사이트를 별도로 구축하여 사용성을 증가시켰지만, 

첫번째 모바일 기기의 크기가 다양해지면서 모든 기기의 사용자들을 만족시킬 수 없다.

두번째 유지 보수의 문제점, 두 개의 사이트에 비용과 시간을 투자해야 함.

세번째 모바일 사용자의 사용성 문제, 때문에 반응형 웹을 사용하게 된다.



그렇지만 반응형 웹의 문제점.

모바일 환경은 데스크톱 환경에 비해 열악하여 페이지 로딩 시간이 느려진다. LTE 환경에서 케이블에 비해 절반 정도의 데이터를 처리하며 2배 정도 시간 지연이 발생한다.

또 gpu, 메모리 등의 사양이 좋지 않아 로딩 시간이 더 길어진다.

원인은 이미지라고 할 수 있다. 화면이 작아졌는데도 필요 이상의 웹 리소스들을 과하게 내려받는 현상을 개선해야 한다. 모바일 환경에서 필요하지 않은 리소스들을 과도하게 다운로드하지 않도록 해야 한다.



**반응형 이미지 구현 방법**

간단하게 사용자의 환경에 적합한 이미지를 전송하면 된다. 특정 환경에서 그 환경에 맞도록 이미 변경된 이미지가 전송되는 것이 반응형 이미지이다.

프런트엔드: 미디어 쿼리를 사용해 클라이언트 환경을 파악한 후, 그에 맞는 이미지 파일을 호출하도록 구현. <img>태그의 srcset 속성이나 <picture> 태그를 사용.

백엔드: 서버에서 클라이언트의 환경에 맞는 이미지를 선택하여 전송. 프런트엔드 코드가 추가되지 않으므로 사이트의 성능을 향상시킬 수 있음. 그렇지만 클라이언트 환경을 어떻게 정확히 판단할 것인가가 문제. Client Hints 를 이용하는 방법이 있음.

픽쳐 태그는 srcset 속성보다 좋고 지원하지 않는 브라우저와 안드로이드 기기가 있다. 하지만 폴리필을 이용할 수 있다. picturefill 등.

반응형 이미지가 사용자 환경에 따라 자동으로 변하지는 않는다. 하지만 브라우저별로 적합한 이미지를 만들어 주는 과정이 필요하다. 이를 Art direction이라고 하는데 어도비사에서 scene7이라는 도구를 통해 이비지를 동적으로 웹에 배포할 수 있는 기능을 제공한다. 하지만 비용과 관리의 어려움이 있다.

Client Hints 헤더는 HTTP 헤더의 일부로 포함되어 전송된다. 서버는 이 정보를 기반으로 응답 내용을 최적화해 다시 브라우저에 전송한다. 



**이미지 지연 로딩**

나타내지 않을 이미지를 처음부터 다운로드하는 것은 웹 성능을 저하시킨다. img 항목에 가짜 이미지를 링크하고, 실제 이미지는 onload 이벤트가 발생할 때 호출하여 링크시키는 방법이 있다.

하지만 실제 상황은 단순하지 않기 때문에 오픈 소스를 이용한다. lazyload



**모바일 우선 접근**

모바일 접속자 수가 데스크톱 접속자 수를 초과했고 앞으로도 증가가 예상되는 만큼 이제는 모바일 우선 접근법을 사용해야 할 것이다.



**적응형 이미지 전략**

서버 측 반응형 웹을 구현할 때 필수적인 이미지 호출 방식이다. 방문자 기기 종류, 화면 크기 등을 감지하고 해당 HTML에 맞는 이미지를 자동으로 선택해 전송한다.

기기를 감지해 정보를 제공해주는 여러 가지 솔루션이 있다. DeviceAtlas, ScientiaMobile/Wurf, 51degree 등이 있다. 무료는 아니다.

CDN 업체에서 기기 검출 모듈을 사용해 요청 헤더에 담아 보내주는 서비스를 고려해볼 수 있다. 다만 자바스크립트가 포함된 첫 번째 페이지를 로딩할 때는 사용할 수 없다.



**캐시 고려 사항**

먼저 접속한 모바일 기기에 적합한 이미지가 캐시된 후, 두 번째 접속한 데스크톱 화면에는 이미 캐시된 모바일 이미지를 다운로드 할 것이다.

이를 피하려면 서버에서 응답할 때 Vary 헤더를 활용해서 특정 헤더에 따라 콘텐츠가 달라질 것이라고 캐시 서버에 알려줘야 한다.