# 4장. 커넥션 관리

## 4.1 TCP 커넥션

- 일단 커넥션이 맺어지면 클라이언트와 서버 간에 주고받는 메시지는 손실 혹은 손상되거나 순서가 바뀌지 않고 안전하게 전달된다.

### 1) 신뢰할 수 있는 데이터 전송 통로인 TCP

- TCP는 HTTP에게 신뢰할 만한 통신 방식을 제공한다.
- TCP 커넥션의 한쪽에 있는 바이트들은 반대쪽으로 순서에 맞게 정확히 전달된다.

### 2) TCP 스트림은 세그먼트로 나뉘어 IP 패킷을 통해 전송된다

- TCP는 IP 패킷(혹은 IP 데이터그램)이라고 불리는 작은 조각을 통해 데이터를 전송한다.
- HTTP는 'IP, TCP, HTTP'로 구성된 프로토콜 스택에서 최상위 계층이다. HTTP에 보안 기능을 더한 HTTPS는 TLS 혹은 SSL이라 불리기도 하며 HTTP와 TCP 사이에 있는 암호화 계층이다.
- TCP는 세그먼트 단위로 데이터 스트림을 잘게 나누고, 세그먼트를 IP 패킷이라고 불리는 봉투에 담아서 인터넷을 통해 데이터를 전달한다. 이 모든 것은 TCP/IP 소프트웨어에 의해 처리되며, 그 과정은 HTTP 프로그래머에게 보이지 않는다.
- IP 패킷은 패킷 헤더, TCP 세그먼트 헤더, TCP 데이터 조각으로 이루어져 있다.
  - IP 헤더 : 발신지와 목적지 IP 주소, 기타 플래그
  - TCP 세그먼트 헤더 : TCP 포트번호, TCP 제어 플래그, 데이터의 순서와 무결성을 검사하기 위한 값

### 3) TCP 커넥션 유지하기

- TCP 커넥션은 `<발신지 IP 주소, 발신지 포트, 수신지 IP 주소, 수신지 포트>`로 유일한 커넥션을 생성한다. 서로 다른 두 개의 TCP 커넥션은 네 가지 주소 구성요소 값이 모두 같을 수 없다.

### 4) TCP 소켓 프로그래밍

- 소켓 API는 HTTP 프로그래머에게 TCP, IP의 세부사항을 숨긴다.

## 4.2 TCP의 성능에 대한 고려

- HTTP 트랜잭션의 성능은 그 아래 계층인 TCP 성능에 영향을 받는다.

### 1) HTTP 트랜잭션 지연

- 트랜잭션을 처리하는 시간은 TCP 커넥션을 설정하고, 요청을 전송하고, 응답 메시지를 보내는 것에 비하면 상당히 짧다. **대부분의 HTTP 지연은 TCP 네트워크 지연 때문에 발생한다.**
- TCP 네트워크 지연은 하드웨어의 성능, 네트워크와 서버의 전송 속도, 요청과 응답 메시지 크기, 클라이언트와 서버 간의 거리에 따라 크게 달라진다. 또한 TCP 프로토콜의 기술적인 복잡성도 지연에 큰 영향을 끼친다.

### 3) TCP 커넥션 핸드셰이크 지연

- 새로운 TCP 커넥션을 열 때면 TCP 소프트웨어는 커넥션을 맺기 위한 조건을 맞추기 위해 연속으로 IP 패킷을 교환한다.

#### 핸드셰이크 순서

1. 클라이언트는 새로운 TCP 커넥션 생성을 위한 `SYN` 플래그를 가지는 TCP 패킷을 서버에게 보낸다. => 🤝 `커넥션 생성 요청`
2. 서버가 커넥션을 받으면 몇 가지 파라미터를 산출하고 요청이 받아들여졌다는 의미의 `SYN` `ACK` 플래그를 포함한 TCP 패킷을 보낸다. => 🤝 `커넥션 요청 허가`
3. 클라이언트는 커넥션이 잘 맺어졌음을 알리기 위해 서버에게 확인응답 신호를 보낸다.

- HTTP 트랜잭션이 아주 큰 데이터를 주고받지 않는 평범한 경우에는, `SYN/SYN+ACK` 핸드셰이크가 눈에 띄는 지연을 발생시킨다.
- 결국 크기가 작은 HTTP 트랜잭션은 50% 이상의 시간을 TCP를 구성하는 데 쓴다.

### 4) 확인응답 지연

- 각 TCP 세그먼트는 순번과 데이터 무결성 checksum을 가진다.