# AWS ELB

- [AWS ELB](#aws-elb)
  - [ELB와 대상 그룹 `Target Group`](#elb와-대상-그룹-target-group)
    - [AWS ELB 작동 방식](#aws-elb-작동-방식)
    - [AWS ELB의 종류](#aws-elb의-종류)
  - [대상 그룹 `Target Group`](#대상-그룹-target-group)
  - [ELB와 Target Group 사용해보기](#elb와-target-group-사용해보기)
    - [대상 그룹 지정하기](#대상-그룹-지정하기)
    - [ELB 사용해보기](#elb-사용해보기)
    - [리스너](#리스너)
    - [가용 영역](#가용-영역)
  - [다중 AZ 사용하기](#다중-az-사용하기)

## ELB와 대상 그룹 `Target Group`

로드밸런서란 다수의 서버에 유입되는 트래픽을 분산시켜서 워크로드의 균형을 잡기 위한 하드웨어를 가리킨다. 현대적인 다수의 애플리케이션은 웹 서버 앞에 로드 밸런서를 배치해 트래픽을 분산시키고 워크로드의 균형을 맞추며 탄력성을 증대시킨다. 다만 문제점도 있는데 대표적으로 로드밸런서가 단일장애지점 `SPOF` 이 될 수 있다는 점이다. 결국 고가용성을 위해서 로드밸런서도 이중화해서 관리해야하는 부담이 존재한다.

일래스틱 로드 밸런싱은 위와 같은 문제를 모두 해결할 수 있는 완전 관리형 서비스이며, 애플리케이션으로 유입되는 트래픽을 EC2 인스턴스에서 호스팅되고 있는 다수의 애플리케이션, 마이크로서비스, 컨테이너 등에 자동으로 분산시킨다.

### AWS ELB 작동 방식

![](https://user-images.githubusercontent.com/30178507/124915768-e16afc80-e02c-11eb-89dc-7bd3e53135f4.png)

위 캡처는 AWS ELB의 고가용성을 구현한 방식을 보여준다.

먼저 ELB가 다운될 가능성이 있는 경우를 살펴보면 내부적으로 각각의 ELB 인스턴스는 다중 AZ 환경에 구현되어 있다. 사용자가 다중 AZ에 애플리케이션을 배포하지 않더라도 ELB는 기본적으로 다중 AZ에 배포한다.

다중 AZ 환경에 개별 ELB VPC 내에 다수의 로드 밸런서 를 배포하는 방식으로 고가용성을 구현할 수 있으며, 사용자는 이를 위해 로드 밸런서에 대해 별도의 환경 설정 작업을 할 필요가 없다. AWS는 로드 밸런서와 관련된 모든 업무를 자동으로 관리하며, 이에 대한 별도의 비용을 청구하지 않는다. 즉, 사용자는 ELB를 이용해 별도의 고정 비용 없이 고가용성을 구현할 수 있다.

### AWS ELB의 종류

[https://www.notion.so/AWS-ELB-0fa6ebf2d7164d9e81c4be66389c683b](https://www.notion.so/AWS-ELB-0fa6ebf2d7164d9e81c4be66389c683b)

## 대상 그룹 `Target Group`

대상 그룹은 ELB의 로드 밸런싱 대상을 논리적으로 그루핑한 그룹을 의미한다.

타깃 그룹은 로드 밸런서와 별개로 존재할 수 있으며, 필요할 때를 대비해서 대상 그룹을 먼저 생성해 놓을 수 있다. 타깃 그룹에 관련 리소스를 계속 추가해 둘 수 있으며, 로드 밸런서 구현 시 갑자기 대상 그룹을 구성할 필요는 없다. 이후 필요 시 대상 그룹을 로드 밸런서에 연결할 수 있다. 대상 그룹은 리전을 기반으로 하므로, 대상 그룹이 있는 하나의 리전에서만 리소스를 할당할 수 있다. 대상 그룹은 Auto Scaling Group과도 잘 연결된다.

EC2 인스턴스, 마이크로서비스, ALB의 컨테이너 기반 애플리케이션, NLB의 인스턴스 또는 IP 주소가 타깃으로 사용될 수 있다. 타입이 IP인 경우, IP 주소는 디음 CIDR 블록 범위 내에서 지정할 수 있다.

- 대상 그룹의 VPC 서브넷
- 10.0.0.0/8
- 100.64.0.0/10
- 172.16.0.0/12
- 192.168.0.0/16

EC2 인스턴스의 경우는 다중 포트 이용 시 동일한 대상 그룹 이름으로 등록할 수 있고, 하나의 대상은 여러 대상 그룹에 등록될 수 있다.

## ELB와 Target Group 사용해보기

### 대상 그룹 지정하기

대상 그룹은 EC2 > 대상 그룹 `Target Group` 탭에서 생성할 수 있다.

![](https://user-images.githubusercontent.com/30178507/125089296-3ed47b80-e109-11eb-8c89-7222c0fdbbf8.png)

위 화면을 보면 대상의 타입을 인스턴스, IP 주소, 람다함수 중 하나로 지정할 수 있다. 대상 그룹의 이름과 프로토콜, 포트를 지정한다. 만약 HTTP나 HTTPS가 프로토콜이라면 프로토콜의 버전도 저장할 수 있다.

![](https://user-images.githubusercontent.com/30178507/125089299-3f6d1200-e109-11eb-90e4-a4f54b91078f.png)

대상 그룹에서 로드벨런서의 헬스 체크 기능도 설정할 수 있다. Application Load Balancer는 HTTP, HTTPS 프로토콜 헬스 체크를 지원하며 Network Load Balancer는 TCP 헬스 체크를 지원한다.

헬스 체크를 통해 특정 대상에 문제가 생긴다면 트래픽을 다른 정상 인스턴스로 옮겨주며 다시 정상 상태로 돌아온다면 로드 밸런서가 트래픽을 전달한다.

이렇게 지정하고 다음 단계에서는 대상 그룹에 들어갈 인스턴스를 지정할 수 있다.

> 인스턴스 지정은 대상 그룹의 대상 타입이 인스턴스일 경우에만 지정한다.
IP 주소라면 IP주소를 람다 함수라면 람다를 지정한다.

![](https://user-images.githubusercontent.com/30178507/125089304-409e3f00-e109-11eb-8f71-57d0ccb9052c.png)

위 설정도 모두 마치고 생성을 누르면 대상 그룹이 생성된다.

### ELB 사용해보기

ELB는 EC2 > 로드 밸런서 탭에서 생성이 가능하다.

![](https://user-images.githubusercontent.com/30178507/125089313-4136d580-e109-11eb-977e-0b11353e22ab.png)

처음에는 로드밸런서의 종류를 선택한다. 대부분 많이 사용하는 Application Load Balancer를 선택한다.

![](https://user-images.githubusercontent.com/30178507/125089321-42680280-e109-11eb-95fc-a21b1fdcfad8.png)

선택을 완료하면 위와 같이 로드밸런서 설정 화면이 나타난다.

### 리스너

리스너는 트래픽이 유입되는 로드 밸런서 리스너의 연결 부분에 대한 프로토콜과 포트를 정의한다.

Application Load Balancer에서는 HTTP, HTTPS 프로토콜을 지원하며 Network Load Balancer에서는 TCP를 지원한다. 포트는 1부터 65535까지의 포트를 지원한다.

### 가용 영역

Load Balancer에서 활성화할 가용영역을 지정한다. AZ당 하나의 서브넷만 지정이 가능하며 가용성을 위해서 2개 이상의 AZ 지정을 추천한다.

위 리스너와 가용영역을 지정하면 기본 지정은 완료되었다. 만약 HTTPS 프로토콜과 같이 보안 프로토콜을 사용하고 있다면 다음 보안 설정 구성 단계에서 인증서 등록이 필요하다.

다음 보안 그룹 설정을 하고 라우팅 구성을 해주어야한다. 라우팅 구성은 ELB가 요청을 라우팅할 대상 그룹을 설정하는 것으로 이 단계에서 새롭게 대상 그룹을 만들수도 있고 기존 대상 그룹을 설정할수도 있다.

## 다중 AZ 사용하기

기본적으로 ELB 인스턴스는 다중 AZ 환경에 구현되어 있다. 사용자가 다중 AZ에 애플리케이션을 배포하지 않더라도 ELB는 기본적으로 다중 AZ에 배포한다. 단, ELB 구성에서 가용영역 설정시 하나의 AZ만 사용하도록 만들 수 있긴한데 최소 2개 이상의 가용영역을 사용할 것을 추천한다.

다중 AZ 사용시 가끔 문제가 나타나곤 하는데, 대표적으로 자바 기반 애플리케이션 이 실행될 때 몇 가지 이슈가 나타날 수 있다. 자바 기반 애플리케이션은 DNS에 있는 서버 IP 주소를 임시 저장하는데 `DNS Cache`, 이 때문에 매번 동일한 인스턴스로 트래픽을 재전송하는 문제가 생기곤 한다. 이는 워크로드에 대한 적절한 분배가 안된 탓에인스턴스 용량의 균형이 맞지 않아서 발생하는 현상으로 크로스 존 로드 밸런싱으로 해결할 수 있다.

크로스 존 로드 밸런싱은 처리 요청을 다중 AZ 간에 균등하게 분배하는 것이며, Application Load Balancer의 기본 기능이므로 사용자가 수동으로 설정할 필요는 없다. Network Load Balancer의 경우 각 로드 밸런서 노드는 해당 AZ에 등록된 타깃으로만 트래픽을 배분한다. 이와 같은 장점을 지닌 크로스 존 로드 밸런싱에 대한 별도의 이용 요금은 없으며, 다중 AZ 환경에서 ALB를 사용할 때 편리하게 이용할 수 있다.

단, 주의할 점은 크로스 존 로드 밸런싱은 AZ 레벨이 아닌 타겟 레벨에서 이뤄진다는 점이다. 예를 들어, 첫 번째 AZ에서 실행 중인 한 개의 인스턴스와 두 번째 AZ에서 실행 중인 세 개의 인스턴스가 있을 때, ALB를 이용해서 두 AZ 에 있는 총 네 개의 타깃을 하나로 묶을 수 있다. 즉, 크로스 존 로드 밸런싱을 이용하변 인스턴스 간에 워크로드가 균등하게 배분되는 것이지 두 개의 AZ 간 에 균등하게 배분되는 것은 아니며, 결과적으로 모든 인스턴스에게 동일한 워크로드가 전달된다.
