## 비정상적인 스레드 종료 상황

- 멀티 스레드를 사용하는 경우에는 스레드에 예외가 발생하였는지 확인하기가 힘들다. 오류가 발생해 스레드가 멈추더라도 애플리케이션은 오류없이 계속 동작한다.
- RuntimeException은 호출 스택을 따라 상위로 전달되기 보다는 현재 실행되는 시점에서 콘솔에 스택 호출 추적 내용을 출력하고 해당 스레드를 종료시킨다.
- 스레드가 죽었을 때 치명적인 경우
    - GUI가 중요한 부분을 차지하는 애플리케이션에서 이벤트 처리 스레드가 종료될 때
- 스레드 풀에서 사용하는 작업용 스레드 같은 작업 처리용 스레드는 Runnable 등의 인터페이스를 통해 남이 정의한 작업만을 실행한다.
    - 작업 처리 스레드는 자신이 실행하는 작업이 제대로 동작하지 않을 수 있다고 가정하고 조심스럽게 실행해야 한다.
        - try-catch 구문을 실행해 예외 상황에 대응한다.
        - try-finally 구문을 사용해 종료되더라도 외부에 종료된다는 사실을 알려 처리할 수 있도록 해야 한다.
            - 스레드풀의 작업 스레드는 스레드풀에게 스레드 종료 사실을 알리고, 스레드풀은 종료된 스레드에 대한 처리를 진행한다.
    - RuntimeException을 catch 구문에서 잡아 처리하는 극소수의 경우
        - 남이 정의한 작업을 실행하는 경우

## 정의되지 않은 예외 처리

- UncatchExceptionHandler를 활용한다.
    - 스레드가 종료되는 시점을 정확히 알 수 있다.
    - 앞의 try-catch, try-finally 를 활용한 예외 처리 방법과 함께 상호보완하며 사용하면 좋다.
    - 스레드 풀에서 예외가 발생했을 때 종료 시점을 아는 방법
        - UncatchExceptionHandler를 적용하는 방법
            - 자바에서는 기본적으로 try-fianlly 구문을 통해 스레드풀에서 예외처리를 하고 있다. 따라서 예외가 발생하면 조용히 스레드가 종료된다. 종료 시점을 알고 싶을 때 UncatchExceptionHandler를 사용한다.
                - 스레드 풀 생성시에 ThreadFactory 클래스를 넘겨준다.
            - 스레드풀에서 submit을 통해 작업을 등록하면 UncatchExceptionHandler에서 처리할 수 없다.
        - try-catch를 사용해 catch 구문에서 종료 시점 처리를 할 수 있다.
        - afterExceutor 메소드를 오버라이드 한다.

## JVM 종료

- 예정대로 종료되는 경우
    - 일반 스레드가 모두 종료되는 시점
    - System.exit, SIGINT 시그널 수신, CTRL+C를 입력받은 경우
- 예기치 못하게 종료되는 경우
- 종료 훅
    - 예정된 절차대로 종료되는 경우 JVM에 등록된 종료 훅을 실행한다.
        - Runtime.addShutdownHook을 통해 등록할 수 있다.
    - 종료 훅이 작업을 마치면 JVM은 클래스의 finalize 메소드를 호출하고 종료한다.
    - JVM은 종료 과정에서 실행되고 있는 스레드에 대해 중단 절차를 진행하거나 인터럽트를 걸지 않는다. 실행 중이던 스레드는 종료절차가 끝나는 시점에서 강제 종료된다. (finalize 실행 후)
    - 종료 훅이나 finalize 메소드가 작업을 마치지 못하고 계속 실행된다면 종료 절차가 멈추는 것으로 볼 수 있고 강제 종료해야 한다.
    - **종료 훅은 스레드 안전하게 만들어야 한다.**
        - 애플리케이션에 대한 어떤 가정도 해서는 안되며 JVM가 종료되는 원인을 생각하고 만들면 안된다.
        - 어떤 상황에서든 아무런 가정 없이 올바르게 동작할 수 있도록 방어적으로 만들어야 한다.
    - 종료 훅은 어떤 서비스나 애플리케이션의 정리하는 용도로 사용하기 좋다.
    - 종료 훅이 여러 개 등록되있는 경우에는 종료 훅의 실행 순서를 제어할 수 없기 때문에 종료 훅에서는 다른 종료 훅이 종료시킬 수 있는 서비스를 사용해서는 안된다.
        - 이런 문제를 해결하기 위해 하나의 종료 훅만 사용해서 종료 훅 내부에 정리해야 하는 서비스를 순차적으로 처리할 수도 있다.

## 데몬 스레드

- 부수적인 기능을 하는 스레드이다.
- 일반 스레드와 데몬 스레드는 종료될 때 처리 방법만 다르고 모두 동일하다.
- JVM은 스레드 하나가 종료되면 일반 스레드가 남아있는지 확인하고 일반 스레드가 모두 종료됐다면 JVM 종료 스레드 절차를 진행한다.
