# 시스템

## 시스템 제작과 사용을 분리하라

- 시작 단계의 준비 과정 코드라는 관심사를 분리해야 한다.

```java
public class Example {
    public Service getService() {
        if(service == null) {
            service = new MyServiceImpl(생성자 인수);
        }
        
        return service;
    }
}
```

위의 코드는 몇 가지 문제를 가지고 있다.

- getService()가 MyServiceImpl과 생성자 인수에 의존한다.
    - 런타임 로직에서 MyServiceImpl 객체를 사용하지 않아도 의존성 해결하지 않으면 컴파일이 안된다.
- 단위 테스트에서도 MyServiceImpl을 신경써야 한다.
    - 해당 객체를 적절히 모킹해줘야만 한다.
    - 일반 런타임 로직과 객체 생성 로직이 섞여 SRP를 위반한다.
- MyServiceImpl이 모든 상황에 필요한 객체인지 확실하지 않다.

### Main 분리

- 생성과 관련한 코드를 main이나 main이 호출하는 모듈로 옮긴다.
- 나머지 시스템은 모든 객체가 생성되고 의존성이 연결되었다고 가정한다.
- main에서 생성한 객체를 애플리케이션에 넘기면 애플리케이션은 그저 사용만 한다.
  
![](../assets/KakaoTalk_Photo_2021-07-11-22-14-20%20001.jpeg)

- 의존성 흐름이 main에서 애플리케이션 쪽을 향하게 된다.

### 팩토리

- abstract factory 패턴을 사용하면 애플리케이션이 생성 시점은 결정하지만 생성하는 코드는 모른다.

![](../assets/KakaoTalk_Photo_2021-07-11-22-14-20%20002.jpeg)

- 의존성이 main에서 OrderProcessing으로 흐른다.
- OrderProcessing은 LineItem이 어떻게 생성되는지 모른다.
- 생성 방법은 오직 LineItemFactory만 알고 있지만 생성 시점을 OrderProcessing이 통제한다.

### 의존성 주입

- 사용과 제작을 분리하는 강력한 메커니즘 중 하나
- 객체가 의존성을 인스턴스로 만드는 책임을 지지 않는다.
- 필요할 떄 DI 컨테이너를 통해 setter나 생성자로 의존성을 설정한다.

## 확장

- 처음부터 올바르게 시스템을 만들 수 있다는 믿음은 미신이다.
- 새로운 스토리에 맞춰 반복적이고 점진적으로 시스템을 조정하고 확장한다.
- 코드 수준에서는 TDD와 리팩터링을 통해 확장할 수 있다.
- 시스템 수준에서는 관심사를 적절히 분리해야 발전할 수 있다.

한 클래스에 트랜잭션 로직과 비즈니스 로직이 섞이면 단위 테스트가 어렵고 새로운 기능을 추가하기 어렵다.

### 횡단 관심사

- 트랜잭션과 같은 관심사는 객체 경계를 넘어 전반적으로 필요하다.
- 영속성을 구현한 코드가 모든 객체에 흩어지지 않게 모듈화한다.

이와 같은 흐름에서 횡단 관심사라는 용어가 나왔다. 

- AOP는 횡단 관심사에 대처하기 위해 모듈성을 확부하는 방법론이다.
- 특정 관심사를 지원하기 위해 특정 지점들이 동작하는 방식을 일관성 있게 바꿔야 한다.
- 예를 들면 영속성은 역속성을 사용할 객체를 선언한 후 영속성 책임을 영속성 프레임워크에 위임한다.
  - AOP 프레임 워크는 대상 코드를 수정하지 않으면서 동작 방식을 변경한다.
  

## 관점 개념을 사용한 메커니즘 3가지
### 자바 프록시

- 개별 객체나 클래스에서 메서드 호출을 감싸는 등 단순한 상황에 적합하다.
- 코드가 많고 복잡하며 실행 지점을 명시하는 메커니즘도 제공하지 않는 것이 단점이다.

### 순수 자바 AOP 프레임워크

- 프록시 코드를 내부에 자동화해 사용한다.
- POJO는 순수하게 도메인에 초점을 맞춘다.
- 상대적으로 단순해 코드를 보수하기 편하다.

### AspectJ 관점

- 언어 차원에서 관점을 모듈화할 수 있는 자바 언어 확장판
- 강력하지만 새 문법과 사용법을 익혀야 하낟.

## 테스트 주도 시스템 아키텍처 구축

- 관점으로 관심사를 분리하는 방식은 막강하다.
  - 도메인 로직을 POJO로 작성할 수 있다.
  - 즉, 코드 수준에서 아키텍처 관심사를 분리해 TDD 아키텍처 구축이 가능해진다.
- 좋은 API는 걸리적거리지 않아야 한다.
  - 단순하면서도 멋지게 분리된 프로젝트를 재빨리 출시한 후 점진적으로 개선해야 한다.
  - 설계가 아무리 멋져도 필요하지 않으면 과유불급이다.
  
## 의사 결정을 최적화하라

- 모듈을 나누고 관심사를 분리하면 기민하게 의사 결정을 할 수 있다.

## 명백한 가치가 있을 때 표준을 현명하게 사용하라

- 재사용성을 높이는 표준을 만들다가 시간이 너무 오래 걸려 고객을 놓치거나 목적을 잊어버리기도 한다.

## 시스템은 도메인 특화 언어가 필요하다

- DSL은 간단한 스크립트 언어나 표준 언어로 구현한 API를 말한다.
  - 도메인 개념과 그 개념을 구현한 코드 사이의 간극을 줄여준다.
  
## 결론

- 시스템은 깨끗해야 한다.
  - 깨끗하지 않으면 논리가 흐려지고 버그가 발생하며 품질이 떨어진다.
- 모든 추상화 단계에서 의도를 명확히 표현해야 한다.
  - 이를 위해 POJO를 작성하고 관심사를 분리해야 한다.